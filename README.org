* Table of Content :TOC_4:
- [[#partitions][Partitions]]
  - [[#bios][BIOS]]
  - [[#uefi][UEFI]]
- [[#packages][Packages]]
  - [[#preparation][Preparation]]
    - [[#cpu-configuration][CPU configuration]]
      - [[#x86_64][x86_64]]
      - [[#i686][i686]]
      - [[#arm][ARM]]
  - [[#cross-tools][Cross tools]]
    - [[#binutils][Binutils]]
    - [[#linux][Linux]]
    - [[#gcc-static][GCC Static]]
    - [[#musl][Musl]]
    - [[#gcc-final][GCC Final]]
    - [[#file][File]]
  - [[#tool-chain][Tool Chain]]
    - [[#musl-1][Musl]]
      - [[#x86_64-1][x86_64]]
      - [[#i686-1][i686]]
      - [[#arm-1][arm]]
    - [[#adjust-cross-tool-chain][Adjust Cross Tool Chain]]
      - [[#modify-compiler-specs][Modify compiler specs]]
      - [[#install-specs][Install specs]]
      - [[#check-tool-chain][Check tool chain]]
      - [[#clean][Clean]]
    - [[#setup][Setup]]
    - [[#binutils-12][Binutils 1/2]]
  - [[#final][Final]]
    - [[#toybox][Toybox]]

* Partitions
** BIOS
Here is the way the different will be mounted and formated for a BIOS system.
| Disk      | Mount Point | Size                      | FS type |
|-----------+-------------+---------------------------+---------|
| /dev/sda1 | /boot       | 256M                      | ext4    |
| /dev/sda2 |             | 2G                        | swap    |
| /dev/sda3 | /           | Space left (at least 10G) | ext4    |
First of all, format the partitions:
#+BEGIN_SRC shell
  mkfs.ext4 /dev/sda1
  mkfs.ext4 /dev/sda3
#+END_SRC
Then, activate the swap partition:
#+BEGIN_SRC shell
  mkswap /dev/sda2
  swapon /dev/sda2
#+END_SRC
Finally, mount the partitions in the =/mnt/ylfs= directory:
#+BEGIN_SRC shell
  export YLFS=/mnt/ylfs
  mkdir -pv ${YLFS}
  mount /dev/sda3 ${YLFS}
  mkdir ${YLFS}/boot
  mount /dev/sda1 ${YLFS}/boot
#+END_SRC
** TODO UEFI
* Packages
** Preparation
Prepare the directories for the sources and patches:
#+BEGIN_SRC shell
  mkdir -v ${YLFS}/sources
  mkdir -v ${YLFS}/cross-tools
  mkdir -v ${YLFS}/tools
  mkdir -v ${YLFS}/sources/{patches,files,packages}
#+END_SRC
Link directories:
#+BEGIN_SRC shell
  ln -sv $YLFS/cross-tools /
  ln -sv $YLFS/tools /
#+END_SRC
Create a new user for the installation of tools:
#+BEGIN_SRC shell
  groupadd ylfs
  useradd -s /bin/bash -g ylfs -m -k /dev/null ylfs
  passwd ylfs
#+END_SRC
Adapt the permissions of the build directories:
#+BEGIN_SRC shell
  chown -v  ylfs ${YLFS}/cross-tools
  chown -vR ylfs ${YLFS}/sources
  chmod -v  a+wt ${YLFS}/sources
  chown -v  ylfs ${YLFS}/tools
#+END_SRC
Login as the =ylfs= user:
#+BEGIN_SRC shell
  su - ylfs
#+END_SRC
Clear compilation C flags:
#+BEGIN_SRC shell
  unset CFLAGS
  unset CXXFLAGS
#+END_SRC
Add multicore compilation:
#+BEGIN_SRC shell
  export MAKEFLAGS="-j $(nproc)"
#+END_SRC
Add future tools to the path:
#+BEGIN_SRC shell
  PATH=/cross-tools:$PATH
#+END_SRC
*** CPU configuration
**** x86_64
Set build options for 64 bit CPUs:
#+BEGIN_SRC shell
  export YLFS_TARGET="x86_64-linux-musl"
  export YLFS_ARCH="x86"
  export YLFS_CPU="x86-64"
#+END_SRC
**** i686
Set build options for 32 bit CPUs:
#+BEGIN_SRC shell
  export YLFS_TARGET="i686-linux-musl"
  export YLFS_ARCH="x86"
  export YLFS_CPU="i686"
#+END_SRC
**** ARM
***** armv7
Set build options for armv7 CPUs:
#+BEGIN_SRC shell
  export YLFS_TARGET="armv7l-linux-musl"
  export YLFS_ARCH="arm"
  export YLFS_CPU="armv7-a"
#+END_SRC
***** armv6
Set build options for armv6 CPUs:
#+BEGIN_SRC shell
  export YLFS_TARGET="armv6l-linux-musl"
  export YLFS_ARCH="arm"
  export YLFS_CPU="armv6"
#+END_SRC
** Cross tools
*** Binutils
Source: https://ftp.gnu.org/gnu/binutils/binutils-2.35.tar.xz \\
Download and extract the sources:
#+BEGIN_SRC shell
  wget https://ftp.gnu.org/gnu/binutils/binutils-2.35.tar.xz
  tar -xf binutils-2.35.tar.xz
  cd binutils-2.35
#+END_SRC
Create the build directory:
#+BEGIN_SRC shell
  mkdir -v build && cd build
#+END_SRC
Configure source:
#+BEGIN_SRC shell
  ../configure \
     --prefix=/cross-tools \
     --target=${YLFS_TARGET} \
     --with-sysroot=/cross-tools/${YLFS_TARGET} \
     --disable-nls \
     --disable-multilib \
     --disable-werror \
     --enable-deterministic-archives \
     --disable-compressed-debug-sections
#+END_SRC
Build:
#+BEGIN_SRC shell
  make
#+END_SRC
Create a symlink for =lib64= (only on x86_64):
#+BEGIN_SRC shell
  mkdir -v /tools/lib && ln -sv lib /tools/lib64
#+END_SRC
Install:
#+BEGIN_SRC shell
  make install
#+END_SRC
*** Linux
Source: https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.8.1.tar.xz \\
Download and extract the sources:
#+BEGIN_SRC shell
  wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.8.1.tar.xz
  tar -xf linux-5.8.1.tar.xz
  cd linux-5.8.1
#+END_SRC
Clean sources:
#+BEGIN_SRC shell
  make mrproper
#+END_SRC
Build headers:
#+BEGIN_SRC shell
  ARCH=$YLFS_ARCH make headers_check
#+END_SRC
Install and clean:
#+BEGIN_SRC shell
  ARCH=$YLFS_ARCH make headers
  rm usr/include/Makefile
  mkdir -pv /cross-tools/${YLFS_TARGET}/include
  cp -rv usr/include/* /cross-tools/${YLFS_TARGET}/include
#+END_SRC
*** GCC Static
Source: https://ftp.gnu.org/gnu/gcc/gcc-10.2.0/gcc-10.2.0.tar.xz \\
Dependencies:
- https://www.mpfr.org/mpfr-current/mpfr-4.1.0.tar.xz
- https://ftp.gnu.org/gnu/mpc/mpc-1.1.0.tar.gz
- https://ftp.gnu.org/gnu/gmp/gmp-6.2.0.tar.xz
Download sources:
#+BEGIN_SRC shell
  wget https://ftp.gnu.org/gnu/gmp/gmp-6.2.0.tar.xz
  wget https://ftp.gnu.org/gnu/mpc/mpc-1.1.0.tar.gz
  wget https://www.mpfr.org/mpfr-current/mpfr-4.1.0.tar.xz
  wget https://ftp.gnu.org/gnu/gcc/gcc-10.2.0/gcc-10.2.0.tar.xz
#+END_SRC
Extract GCC:
#+BEGIN_SRC shell
  tar -xf gcc-10.2.0.tar.xz
  cd gcc-10.2.0
#+END_SRC
Extract dependencies:
#+BEGIN_SRC shell
  tar -xf ../mpfr-4.1.0.tar.xz
  mv -v mpfr-4.1.0 mpfr
  tar -xf ../gmp-6.2.0.tar.xz
  mv -v gmp-6.2.0 gmp
  tar -xf ../mpc-1.1.0.tar.gz
  mv -v mpc-1.1.0 mpc
#+END_SRC
Create the build directory:
#+BEGIN_SRC shell
  mkdir -v build && cd build
#+END_SRC
Configure sources:
#+BEGIN_SRC shell
  CFLAGS='-g0 -O0' \
  CXXFLAGS='-g0 -O0' \
  ../configure \
            --prefix=${YLFS}/cross-tools --build=${MACHTYPE} \
            --host=${MACHTYPE}   --target=${YLFS_TARGET} \
            --with-sysroot=${YLFS}/cross-tools/${YLFS_TARGET} \
            --disable-nls         --with-newlib  \
            --disable-libitm     --disable-libvtv \
            --disable-libssp     --disable-shared \
            --disable-libgomp    --without-headers \
            --disable-threads    --disable-multilib \
            --disable-libatomic  --disable-libstdcxx \
            --enable-languages=c --disable-libquadmath \
            --disable-libsanitizer --with-arch=${YLFS_CPU} \
            --disable-decimal-float --enable-clocale=generic
#+END_SRC
Build and install the only the minimum needed:
#+BEGIN_SRC shell
  make all-gcc all-target-libgcc
  make install-gcc install-target-libgcc
#+END_SRC
*** Musl
Source: https://www.musl-libc.org/releases/musl-1.2.1.tar.gz \\
Download and extract the sources:
#+BEGIN_SRC shell
  wget https://www.musl-libc.org/releases/musl-1.2.1.tar.gz
  tar -xf musl-1.2.1.tar.gz
  cd musl-1.2.1
#+END_SRC
Configure cross build:
#+BEGIN_SRC shell
  ./configure \
    CROSS_COMPILE=${YLFS_TARGET}- \
    --prefix=/ \
    --target=${YLFS_TARGET}
#+END_SRC
Build and install:
#+BEGIN_SRC shell
  make && DESTDIR=/cross-tools make install
#+END_SRC
Create the missing directory and link the library:
#+BEGIN_SRC shell
  mkdir -v /cross-tools/usr
  ln -sv ../include /cross-tools/usr/include
#+END_SRC
*** GCC Final
Delete the old build directory:
#+BEGIN_SRC shell
  rm -rf build/
#+END_SRC
Use =lib= instead of =lib64=:
#+BEGIN_SRC shell
  sed -i '/m64=/s/lib64/lib/' gcc/config/i386/t-linux64
  sed -i 's/lib64/lib/'       gcc/config/i386/linux64.h
#+END_SRC
Create the build directory:
#+BEGIN_SRC shell
  mkdir -v build && cd build
#+END_SRC
Configure sources:
#+BEGIN_SRC shell
  AR=ar LDFLAGS="-Wl,-rpath,/cross-tools/lib" \
  ../configure \
      --prefix=/cross-tools \
      --build=${YLFS_HOST} \
      --host=${YLFS_HOST} \
      --target=${YLFS_TARGET} \
      --disable-multilib \
      --with-sysroot=/cross-tools \
      --disable-nls \
      --enable-shared \
      --enable-languages=c,c++ \
      --enable-threads=posix \
      --enable-clocale=generic \
      --enable-libstdcxx-time \
      --enable-fully-dynamic-string \
      --disable-symvers \
      --disable-libsanitizer \
      --disable-lto-plugin \
      --disable-libssp
#+END_SRC
Build:
#+BEGIN_SRC shell
  make AS_FOR_TARGET="${YLFS_TARGET}-as" \
  LD_FOR_TARGET="${YLFS_TARGET}-ld"
#+END_SRC
Install
#+BEGIN_SRC shell
  make install
#+END_SRC
*** File
Source: ftp://ftp.astron.com/pub/file/file-5.39.tar.gz \\
Download and extract the sources:
#+BEGIN_SRC shell
  wget ftp://ftp.astron.com/pub/file/file-5.39.tar.gz
  tar -xf file-5.39.tar.gz
  cd file-5.39
#+END_SRC
Configure sources:
#+BEGIN_SRC shell
  ./configure --prefix=/cross-tools --disable-libseccomp
#+END_SRC
Build and install:
#+BEGIN_SRC shell
  make && make install
#+END_SRC
** Tool Chain
*** Musl
Configure sources:
#+BEGIN_SRC shell
  ./configure \
    CROSS_COMPILE=${YLFS_TARGET}- \
    --prefix=/ \
    --target=${YLFS_TARGET}
#+END_SRC
Build and install: 
#+BEGIN_SRC shell
  make && make DESTDIR=/tools install
#+END_SRC
Verify symlinks:
**** x86_64
#+BEGIN_SRC shell
  rm -v  /tools/lib/ld-musl-x86_64.so.1
  ln -sv libc.so /tools/lib/ld-musl-x86_64.so.1
#+END_SRC
**** i686
#+BEGIN_SRC shell
  rm -v  /tools/lib/ld-musl-i686.so.1
  ln -sv libc.so /tools/lib/ld-musl-i686.so.1
#+END_SRC
**** arm
#+BEGIN_SRC shell
  rm -v  /tools/lib/ld-musl-arm.so.1
  ln -sv libc.so /tools/lib/ld-musl-arm.so.1
#+END_SRC
*** Adjust Cross Tool Chain
Needed when host's libc isn't musl.\\
**** Modify compiler specs
Dump current cross-gcc specs:
#+BEGIN_SRC shell
  export SPECFILE=`dirname $(${YLFS_TARGET}-gcc -print-libgcc-file-name)`/specs
  ${YLFS_TARGET}-gcc -dumpspecs > specs
#+END_SRC
Modify dumped specs file:
***** x86_64
#+BEGIN_SRC shell
  sed -i 's/\/lib\/ld-musl-x86_64.so.1/\/tools\/lib\/ld-musl-x86_64.so.1/g' specs
  grep "/tools/lib/ld-musl-x86_64.so.1" specs  --color=auto
#+END_SRC
***** i686
#+BEGIN_SRC shell
  sed -i 's/\/lib\/ld-musl-i386.so.1/\/tools\/lib\/ld-musl-i386.so.1/g' specs
  grep "/tools/lib/ld-musl-i386.so.1" specs  --color=auto
#+END_SRC
***** arm
#+BEGIN_SRC shell
  sed -i 's/\/lib\/ld-musl-arm/\/tools\/lib\/ld-musl-arm/g' specs
  grep "/tools/lib/ld-musl-arm" specs  --color=auto
#+END_SRC
**** Install specs
Install the modified specs:
#+BEGIN_SRC shell
  mv -v specs $SPECFILE
  unset SPECFILE
#+END_SRC
**** Check tool chain
Create test file to test the compiler:
#+BEGIN_SRC shell
echo 'int main(){}' > test.c
#+END_SRC
Compile and test the test file:
#+BEGIN_SRC shell
${YLFS_TARGET}-gcc test.c
${YLFS_TARGET}-readelf -l a.out | grep Requesting
#+END_SRC
***** x86_64
Output should be: =Requesting program interpreter: /tools/lib/ld-musl-x86_64.so.1=.
***** i686
Output should be: =Requesting program interpreter: /tools/lib/ld-musl-i386_64.so.1=.
***** arm
Output should be: =Requesting program interpreter: /tools/lib/ld-musl-arm.so.1=.
**** Clean
Clean the outputed file:
#+BEGIN_SRC shell
rm -v a.out test.c 
#+END_SRC
*** Setup
Export variables to use cross-tools:
#+BEGIN_SRC shell
  export CC="${YLFS_TARGET}-gcc"
  export CXX="${YLFS_TARGET}-g++"
  export AR="${YLFS_TARGET}-ar"
  export AS="${YLFS_TARGET}-as"
  export RANLIB="${YLFS_TARGET}-ranlib"
  export LD="${YLFS_TARGET}-ld"
  export STRIP="${YLFS_TARGET}-strip"
#+END_SRC
*** Binutils 1/2
Delete the old build directory:
#+BEGIN_SRC shell
  rm -rf build/
#+END_SRC
Create the build directory:
#+BEGIN_SRC shell
  mkdir -v build && cd build
#+END_SRC
Configure sources:
#+BEGIN_SRC shell
  ../configure --prefix=/tools            \
               --with-sysroot=$MLFS        \
               --with-lib-path=/tools/lib \
               --build=${MLFS_HOST} \
               --host=${MLFS_TARGET} \
               --target=${MLFS_TARGET}          \
               --disable-nls              \
               --disable-werror
#+END_SRC
Build:
#+BEGIN_SRC shell
  make
#+END_SRC
Create a symlink for =lib64= (only on x86_64):
#+BEGIN_SRC shell
  ln -sv lib /tools/lib64
#+END_SRC
Install:
#+BEGIN_SRC shell
  make install
#+END_SRC
** Final
*** Toybox
Source: https://landley.net/toybox/downloads/toybox-0.8.3.tar.gz
Download and extract the sources:
#+BEGIN_SRC shell
  wget https://landley.net/toybox/downloads/toybox-0.8.3.tar.gz
  tar -xf toybox-0.8.3.tar.gz
  cd toybox-0.8.3
#+END_SRC
Configure, build and install.
#+BEGIN_SRC shell
  CROSS_COMPILE=$YLFS_CPU make defconfig
  make
  PREFIX=${YLFS}/cross-tools make install
#+END_SRC
